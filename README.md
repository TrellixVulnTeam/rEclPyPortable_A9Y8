
<!-- README.md is generated from README.Rmd. Please edit that file -->

# rEclPyPortable

The goal of `rEclPyPortable` is to serve as an R wrapper of the class
`EclBinaryParser`, written in Python by Konstantin Sermyagin, a
reservoir engineer. The class converts the reservoir simulation output
files generated by Eclipse from binary to dataframes.

## Installation

For the moment, `rEclPyPortable` is only available through Github.

Once is completed it will be submitted to CRAN. You can install it in
the meantime by two methods:

  - cloning or downloading the package from Github
  - install it using `devtools::install_github("f0nzie/rEclPyPortable",
    ref = "the_branch")`, where the branch could be `master` or
    `develop`, depending how newer or bleeding edge you like it.

## Requirements

  - R 3.5.3
  - Rtools 3.5
  - RStudio 1.2+. *I used RStudio preview 1.2.1327 for the development
    of the package.*
  - WinPython 3.6 64-bit

## Files used for testing

For testing `rEcl` and `EclBinaryParser` I used the output binary files
from the reservoir simulation of the Volve field.

    VOLVE_2016.INIT
    VOLVE_2016.RSSPEC
    VOLVE_2016.SMSPEC
    VOLVE_2016.UNSMRY

You can find a copy of these files in this repository under
[rEcl/inst/python/volve](https://github.com/f0nzie/rEcl/tree/master/inst/python/volve),
but the `rEcl` package will not install them. You will have to copy
these files manually. In the future, I plan to download the files
directly from Zenodo or Google drive; mainly, because these files are
too big for an R package.

## Functions for the class EclBinaryParser

  - `get_dimens`
  - `is_dual`
  - `get_actnum`
  - `get_seqnum_dates`
  - `read_prop_array`
  - `read_prop_time`
  - `read_vectors`

### New functions

  - `get_vectors_shape`: get the shape or dimensions of the vectors
    dataframe
  - `get_vector_names`: get the names of all the vectors
  - `get_vector_column`: get the values for a vector-column

## Examples

### Example reservoir model SPE6

We start by reading the file `SPE6_FRAC.UNSMRY`. This file , because is
relatively small, we can include it with the package. We willread it
from the package installation folder.

``` r
list.files(system.file("py-project",  package = "rEclPyPortable"))
#>  [1] "jupyter-notebook.lnk"                      
#>  [2] "multiindex_for_columns.ipynb"              
#>  [3] "notebooks"                                 
#>  [4] "pyrestools-starter.ipynb"                  
#>  [5] "pyrestools_testing_and_experimenting.ipynb"
#>  [6] "rawdata"                                   
#>  [7] "read_vectors.log"                          
#>  [8] "restools"                                  
#>  [9] "restools_import.Rmd"                       
#> [10] "restools_new_functions.Rmd"                
#> [11] "tests"                                     
#> [12] "WPy64-3670Zero"
```

``` r
library(reticulate)

venv_dir <- system.file("py-project", "WPy64-3670Zero", "python-3.6.7.amd64",
                        package = "rEclPyPortable")
interpreter <- file.path(venv_dir, "python.exe")

reticulate::use_python(interpreter, required = TRUE)
reticulate::py_config()
#> python:         C:/Users/msfz751/Documents/R/win-library/3.5/rEclPyPortable/py-project/WPy64-3670Zero/python-3.6.7.amd64/python.exe
#> libpython:      C:/Users/msfz751/Documents/R/win-library/3.5/rEclPyPortable/py-project/WPy64-3670Zero/python-3.6.7.amd64/python36.dll
#> pythonhome:     C:\Users\msfz751\DOCUME~1\R\WIN-LI~1\3.5\RECLPY~1\PY-PRO~1\WPY64-~1\PYTHON~1.AMD
#> version:        3.6.7 (v3.6.7:6ec5cf24b7, Oct 20 2018, 13:35:33) [MSC v.1900 64 bit (AMD64)]
#> Architecture:   64bit
#> numpy:          C:\Users\msfz751\DOCUME~1\R\WIN-LI~1\3.5\RECLPY~1\PY-PRO~1\WPY64-~1\PYTHON~1.AMD\lib\site-packages\numpy
#> numpy_version:  1.16.2
#> 
#> NOTE: Python version was forced by use_python function
```

``` r
library(rEclPyPortable)

ecl_folder <- system.file("rawdata", package = "rEclPyPortable")
ecl_folder
#> [1] "C:/Users/msfz751/Documents/R/win-library/3.5/rEclPyPortable/rawdata"
unsmry_file <- file.path(ecl_folder, "spe6", "SPE6_FRAC.UNSMRY")
file.exists(unsmry_file)
#> [1] TRUE
```

We connect to Python and load the class `EclBinaryParser` which resides
in the Python package called `restools`. You can take a look at
`restools` under the R installation folder in your lcoal disk.

Once we connect and load the Python package, we create an instance of
the class `EclBinaryParser` providing the parse object `py` and the full
name of the Eclipse binary file.

``` r
# rEclTest:::check_python_version()
# rEclTest:::check_restools_present()
```

``` r
py <- restools_connect()
parser <- EclBinaryParser(py, unsmry_file)
```

First basic task is finding the dimensions of the reservoir model. We do
that with `get_dimensions`.

``` r
get_dimensions(parser)
#> DIMENS(ni=10, nj=1, nk=10)
```

This is a heavier operation; reading the vectors.

``` r
vectors <- read_vectors(parser)
```

Get the shape or dimensions of the vector dataframe.

``` r
get_vectors_shape(parser)
#> [1] 69 32
```

We get the names of the vectors we specified in our input file.

``` r
get_vector_names(parser)
#>  [1] "BGSAT" "BOSAT" "BPR"   "BRS"   "BWSAT" "FGOR"  "FGPR"  "FOPR" 
#>  [9] "FPR"   "TIME"  "WBHP"  "YEARS"
```

We now want a dataframe corresponding to a specific vector-column with
`get_vector_column`:

``` r
get_vector_column(parser, "FOPR")
#>           FOPR
#> 1    0.0000000
#> 2  495.8547363
#> 3  496.4673462
#> 4  497.7044983
#> 5  500.0000000
#> 6  500.0000000
#> 7  500.0000000
#> 8  500.0000000
#> 9  500.0000000
#> 10 500.0000000
#> 11 499.0129700
#> 12 495.0864258
#> 13 491.3752441
#> 14 487.6884460
#> 15 483.7983093
#> 16 479.4172058
#> 17 474.9851074
#> 18 470.4046021
#> 19 465.6196289
#> 20 460.7243347
#> 21 455.7453308
#> 22 450.6983032
#> 23 445.5942688
#> 24 440.4420471
#> 25 435.2494202
#> 26 430.0222778
#> 27 424.0520325
#> 28 416.5676270
#> 29 408.7698059
#> 30 400.7507019
#> 31 392.5427246
#> 32 384.1553650
#> 33 375.7556763
#> 34 367.2411499
#> 35 358.5085144
#> 36 349.5070496
#> 37 339.1749573
#> 38 327.4499817
#> 39 315.0457153
#> 40 301.9628906
#> 41 288.1910400
#> 42 273.9568787
#> 43 259.3403320
#> 44 243.6156769
#> 45 223.3641968
#> 46 201.8397217
#> 47 179.7216034
#> 48 157.3689117
#> 49 135.5422974
#> 50 114.8100815
#> 51  91.3848877
#> 52  66.5469284
#> 53  44.1556320
#> 54  26.0932941
#> 55  13.4400187
#> 56   5.8621721
#> 57   5.2417884
#> 58   4.5437417
#> 59   3.6096404
#> 60   2.4702997
#> 61   1.3012712
#> 62   0.4364305
#> 63   0.0000000
#> 64   0.0000000
#> 65   0.0000000
#> 66   0.0000000
#> 67   0.0000000
#> 68   0.0000000
#> 69   0.0000000
```

Finally, because the function `get_vector_column` is vectorized, we can
get a dataframe of multiple columns.

``` r
# get several vectors at once
df_vars <- tibble::as_tibble(get_vector_column(parser, c("FPR", "FGOR", "FOPR")))
df_vars
#> # A tibble: 69 x 3
#>      FPR  FGOR  FOPR
#>    <dbl> <dbl> <dbl>
#>  1 6025.  0       0 
#>  2 6022.  1.53  496.
#>  3 6011.  1.53  496.
#>  4 5978.  1.53  498.
#>  5 5878.  1.53  500 
#>  6 5744.  1.53  500 
#>  7 5609   1.53  500 
#>  8 5528.  1.54  500 
#>  9 5492.  1.56  500 
#> 10 5459.  1.58  500 
#> # ... with 59 more rows
```

## Example reservoir model PUNQ-S3

PUNQ-S3 is a synthetic reservoir model that is used for testing and
calibrating reservoir simulators. These are the files available with the
package:

    PUNQS3.INIT
    PUNQS3.INSPEC
    PUNQS3.RSSPEC
    PUNQS3.SMSPEC
    PUNQS3.UNRST
    PUNQS3.UNSMRY

You may list the files with:

`list.files(system.file("python", "volve", package = "rEcl"))`

``` r
library(reticulate)
library(rEclPyPortable)

venv_dir <- system.file("py-project", "WPy64-3670Zero", "python-3.6.7.amd64",
                        package = "rEclPyPortable")

interpreter <- file.path(venv_dir, "python.exe")
reticulate::use_python(interpreter, required = TRUE)
reticulate::py_config()
#> python:         C:/Users/msfz751/Documents/R/win-library/3.5/rEclPyPortable/py-project/WPy64-3670Zero/python-3.6.7.amd64/python.exe
#> libpython:      C:/Users/msfz751/Documents/R/win-library/3.5/rEclPyPortable/py-project/WPy64-3670Zero/python-3.6.7.amd64/python36.dll
#> pythonhome:     C:\Users\msfz751\DOCUME~1\R\WIN-LI~1\3.5\RECLPY~1\PY-PRO~1\WPY64-~1\PYTHON~1.AMD
#> version:        3.6.7 (v3.6.7:6ec5cf24b7, Oct 20 2018, 13:35:33) [MSC v.1900 64 bit (AMD64)]
#> Architecture:   64bit
#> numpy:          C:\Users\msfz751\DOCUME~1\R\WIN-LI~1\3.5\RECLPY~1\PY-PRO~1\WPY64-~1\PYTHON~1.AMD\lib\site-packages\numpy
#> numpy_version:  1.16.2
#> 
#> NOTE: Python version was forced by use_python function

ecl_folder <- system.file("rawdata", package = "rEclPyPortable")
unsmry_file <- file.path(ecl_folder, "PUNQS3", "PUNQS3.UNSMRY")
file.exists(unsmry_file)
#> [1] TRUE
```

``` r
# connect to Python and start a class instance
py <- restools_connect()
parser <- EclBinaryParser(py, unsmry_file)

# dimensions of the reservoir model
get_dimensions(parser)
#> DIMENS(ni=19, nj=28, nk=5)
```

``` r
# reading the Eclipse vectors. this may take few seconds id the reservoir is too complex
vectors <- read_vectors(parser)

# Get the shape or dimensions of the vector dataframe.
get_vectors_shape(parser)
#> [1] 179  15
```

``` r
# We get the names of the vectors we specified in our input file.
get_vector_names(parser)
#>  [1] "FGOR"     "FGPT"     "FOPR"     "FOPT"     "FWCT"     "FWPT"    
#>  [7] "TIME"     "TIMESTEP" "WBHP"     "YEARS"
```

``` r
# dataframe corresponding to a specific vector-column
get_vector_column(parser, "FOPR")
#>          FOPR
#> 1      0.0000
#> 2      0.0000
#> 3    600.0000
#> 4    600.0000
#> 5    600.0000
#> 6    600.0000
#> 7    600.0000
#> 8    600.0000
#> 9    600.0000
#> 10   600.0000
#> 11   600.0000
#> 12  1200.0000
#> 13  1200.0000
#> 14  1200.0000
#> 15  1200.0000
#> 16  1200.0000
#> 17  1200.0000
#> 18   600.0000
#> 19   600.0000
#> 20   600.0000
#> 21   600.0000
#> 22   600.0000
#> 23   600.0000
#> 24   300.0000
#> 25   300.0000
#> 26   300.0000
#> 27   300.0000
#> 28   300.0000
#> 29   300.0000
#> 30     0.0000
#> 31     0.0000
#> 32     0.0000
#> 33     0.0000
#> 34     0.0000
#> 35     0.0000
#> 36     0.0000
#> 37     0.0000
#> 38     0.0000
#> 39   900.0000
#> 40   900.0000
#> 41   900.0000
#> 42   900.0000
#> 43   900.0000
#> 44   900.0000
#> 45   900.0000
#> 46   900.0000
#> 47     0.0000
#> 48     0.0000
#> 49     0.0000
#> 50     0.0000
#> 51   900.0000
#> 52   900.0000
#> 53   900.0000
#> 54   900.0000
#> 55   900.0000
#> 56   900.0000
#> 57   900.0000
#> 58   900.0000
#> 59     0.0000
#> 60     0.0000
#> 61     0.0000
#> 62     0.0000
#> 63   900.0000
#> 64   900.0000
#> 65   900.0000
#> 66   900.0000
#> 67   900.0000
#> 68   862.5000
#> 69   834.3750
#> 70   834.3750
#> 71     0.0000
#> 72     0.0000
#> 73     0.0000
#> 74     0.0000
#> 75   900.0000
#> 76   900.0000
#> 77   900.0000
#> 78   900.0000
#> 79   900.0000
#> 80   900.0000
#> 81   892.9762
#> 82     0.0000
#> 83     0.0000
#> 84     0.0000
#> 85     0.0000
#> 86   900.0000
#> 87   900.0000
#> 88   898.3598
#> 89   894.4315
#> 90   890.6831
#> 91   888.4182
#> 92   880.6496
#> 93     0.0000
#> 94     0.0000
#> 95     0.0000
#> 96     0.0000
#> 97   897.3006
#> 98   893.7467
#> 99   889.1471
#> 100  884.1654
#> 101  877.8188
#> 102  874.2231
#> 103  860.3490
#> 104    0.0000
#> 105    0.0000
#> 106    0.0000
#> 107    0.0000
#> 108  889.7090
#> 109  884.1975
#> 110  873.6402
#> 111  861.9726
#> 112  851.0178
#> 113  842.5769
#> 114  820.3649
#> 115    0.0000
#> 116    0.0000
#> 117    0.0000
#> 118    0.0000
#> 119  851.9354
#> 120  843.3365
#> 121  832.3793
#> 122  821.0728
#> 123  809.2431
#> 124  796.5966
#> 125  765.6595
#> 126    0.0000
#> 127    0.0000
#> 128    0.0000
#> 129    0.0000
#> 130  808.3836
#> 131  798.3890
#> 132  783.0869
#> 133  767.2960
#> 134  751.8171
#> 135  740.5112
#> 136  710.6010
#> 137    0.0000
#> 138    0.0000
#> 139    0.0000
#> 140    0.0000
#> 141  747.0986
#> 142  737.8694
#> 143  724.7645
#> 144  710.1848
#> 145  694.0875
#> 146  681.2035
#> 147  651.1420
#> 148    0.0000
#> 149    0.0000
#> 150    0.0000
#> 151    0.0000
#> 152  681.1065
#> 153  673.4787
#> 154  662.4407
#> 155  650.0897
#> 156  637.5364
#> 157  628.9332
#> 158  611.1095
#> 159    0.0000
#> 160    0.0000
#> 161    0.0000
#> 162    0.0000
#> 163  637.6225
#> 164  630.9486
#> 165  621.4207
#> 166  611.5229
#> 167  603.4231
#> 168  598.5114
#> 169  587.7632
#> 170    0.0000
#> 171    0.0000
#> 172    0.0000
#> 173    0.0000
#> 174  612.2325
#> 175  606.1571
#> 176  597.6083
#> 177  589.1541
#> 178  583.0701
#> 179  579.7202
```

``` r
# get a dataframe of multiple columns
# vectorized function to get several vectors at once
df_vars <- get_vector_column(parser, c("YEARS", "FGOR", "FOPR", "FWCT"))
tibble::as_tibble(df_vars)
#> # A tibble: 179 x 4
#>        YEARS  FGOR  FOPR        FWCT
#>        <dbl> <dbl> <dbl>       <dbl>
#>  1 0           0       0 0          
#>  2 0.0000274   0       0 0          
#>  3 0.000301   74     600 0.000000199
#>  4 0.00112    74     600 0.000000609
#>  5 0.00277    74.0   600 0.00000113 
#>  6 0.00769    73.9   600 0.00000189 
#>  7 0.0225     73.6   600 0.00000290 
#>  8 0.0537     73.2   600 0.00000394 
#>  9 0.0849     73.0   600 0.00000460 
#> 10 0.162      72.7   600 0.00000563 
#> # ... with 169 more rows
```

Eclipse vectors that are different in nature, such as well (start with
**W**) variables, will get a different size than field variables (start
with **F**):

``` r
# read a well variable
tibble::as_tibble(get_vector_column(parser, "WBHP"))
#> # A tibble: 1,074 x 1
#>     WBHP
#>    <dbl>
#>  1    0 
#>  2    0 
#>  3  221.
#>  4  221.
#>  5  220.
#>  6  219.
#>  7  218.
#>  8  217.
#>  9  216.
#> 10  215.
#> # ... with 1,064 more rows
```

## Example reservoir model Volve

    VOLVE_2016.INIT
    VOLVE_2016.RSSPEC
    VOLVE_2016.SMSPEC
    VOLVE_2016.UNSMRY

You may list the files with:

`list.files(system.file("python", "volve", package = "rEcl"))`

``` r
library(reticulate)
library(rEclPyPortable)

venv_dir <- system.file("py-project", "WPy64-3670Zero", "python-3.6.7.amd64",
                        package = "rEclPyPortable")

interpreter <- file.path(venv_dir, "python.exe")
reticulate::use_python(interpreter, required = TRUE)
reticulate::py_config()
#> python:         C:/Users/msfz751/Documents/R/win-library/3.5/rEclPyPortable/py-project/WPy64-3670Zero/python-3.6.7.amd64/python.exe
#> libpython:      C:/Users/msfz751/Documents/R/win-library/3.5/rEclPyPortable/py-project/WPy64-3670Zero/python-3.6.7.amd64/python36.dll
#> pythonhome:     C:\Users\msfz751\DOCUME~1\R\WIN-LI~1\3.5\RECLPY~1\PY-PRO~1\WPY64-~1\PYTHON~1.AMD
#> version:        3.6.7 (v3.6.7:6ec5cf24b7, Oct 20 2018, 13:35:33) [MSC v.1900 64 bit (AMD64)]
#> Architecture:   64bit
#> numpy:          C:\Users\msfz751\DOCUME~1\R\WIN-LI~1\3.5\RECLPY~1\PY-PRO~1\WPY64-~1\PYTHON~1.AMD\lib\site-packages\numpy
#> numpy_version:  1.16.2
#> 
#> NOTE: Python version was forced by use_python function

# binary files
ecl_folder <- system.file("rawdata", package = "rEclPyPortable")
unsmry_file <- file.path(ecl_folder, "volve", "VOLVE_2016.UNSMRY")
file.exists(unsmry_file)
#> [1] TRUE
```

``` r
# connect to Python and start a class instance
py <- restools_connect()
parser <- EclBinaryParser(py, unsmry_file)

# dimensions of the reservoir model
get_dimensions(parser)
#> DIMENS(ni=108, nj=100, nk=63)
```

``` r
# reading the Eclipse vectors. 
# this may take few seconds id the reservoir is too complex
vectors <- read_vectors(parser)

# Get the shape or dimensions of the vector dataframe.
get_vectors_shape(parser)
#> [1] 1611 5000
```

``` r
# We get the names of the vectors we specified in our input file.
get_vector_names(parser)
#>   [1] "COPR"     "COPT"     "CWFR"     "CWIR"     "CWPR"     "CWPT"    
#>   [7] "FGIR"     "FGIT"     "FGLIR"    "FGOR"     "FGORH"    "FGPR"    
#>  [13] "FGPT"     "FLPR"     "FLPT"     "FMCTP"    "FMWWO"    "FMWWT"   
#>  [19] "FODEN"    "FOE"      "FOIP"     "FOPR"     "FOPRF"    "FOPRH"   
#>  [25] "FOPRS"    "FOPT"     "FOPTH"    "FPR"      "FVIR"     "FVIT"    
#>  [31] "FVPR"     "FVPT"     "FWCT"     "FWCTH"    "FWIP"     "FWIR"    
#>  [37] "FWIT"     "FWPR"     "FWPT"     "GGOR"     "GGPR"     "GGPT"    
#>  [43] "GOPR"     "GOPT"     "GVIR"     "GVIT"     "GVPR"     "GVPT"    
#>  [49] "GWCT"     "GWIR"     "GWPR"     "MSUMLINS" "RGPV"     "RHPV"    
#>  [55] "ROE"      "ROEW"     "ROPV"     "ROSAT"    "RPR"      "RRPV"    
#>  [61] "RWPV"     "TCPU"     "TIME"     "WBHP"     "WBHPH"    "WBP"     
#>  [67] "WBP4"     "WBP9"     "WGIR"     "WGIT"     "WGLIR"    "WGOR"    
#>  [73] "WGORH"    "WGPR"     "WGPRH"    "WGPTH"    "WLPR"     "WLPRH"   
#>  [79] "WLPT"     "WLPTH"    "WMCON"    "WMCTL"    "WOPR"     "WOPRH"   
#>  [85] "WOPT"     "WOPTH"    "WPI"      "WTHP"     "WTICIW1"  "WTICIW2" 
#>  [91] "WTIRIW1"  "WTIRIW2"  "WTPCIW1"  "WTPCIW2"  "WTPRIW1"  "WTPRIW2" 
#>  [97] "WWCT"     "WWCTH"    "WWIR"     "WWIRH"    "WWIT"     "WWITH"   
#> [103] "WWPR"     "WWPRH"    "WWPT"     "WWPTH"    "YEARS"
```

``` r
# dataframe corresponding to a specific vector-column
# tibble::as_tibble(get_vector_column(parser, "FOPR"))
```

``` r
# get a dataframe of multiple columns
# vectorized function to get several vectors at once
df_vars <- get_vector_column(parser, c("YEARS", "FGOR", "FOPR", "FWCT"))
tibble::as_tibble(df_vars)
#> # A tibble: 1,611 x 4
#>      YEARS  FGOR  FOPR  FWCT
#>      <dbl> <dbl> <dbl> <dbl>
#>  1 0           0     0     0
#>  2 0.00274     0     0     0
#>  3 0.00447     0     0     0
#>  4 0.00636     0     0     0
#>  5 0.00958     0     0     0
#>  6 0.0149      0     0     0
#>  7 0.0225      0     0     0
#>  8 0.0301      0     0     0
#>  9 0.0400      0     0     0
#> 10 0.0487      0     0     0
#> # ... with 1,601 more rows
```

Eclipse vectors that are different in nature, such as well (start with
**W**) variables, will get a different size than field variables (start
with **F**):

``` r
# read a well variable
tibble::as_tibble(get_vector_column(parser, "WBHP"))
#> # A tibble: 45,108 x 1
#>     WBHP
#>    <dbl>
#>  1     0
#>  2     0
#>  3     0
#>  4     0
#>  5     0
#>  6     0
#>  7     0
#>  8     0
#>  9     0
#> 10     0
#> # ... with 45,098 more rows
```
